<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Gi·ªè h√†ng</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>

<h1>üõí Gi·ªè h√†ng c·ªßa b·∫°n</h1>

<div id="cart"></div>
<h3 id="total"></h3>

<!-- ====== TH√îNG TIN KH√ÅCH H√ÄNG ====== -->
<div class="customer-info">
    <h3>üìã Th√¥ng tin kh√°ch h√†ng</h3>

    <input id="tenKhach" type="text" placeholder="H·ªç v√† t√™n">
    <input id="sdtKhach" type="text" placeholder="S·ªë ƒëi·ªán tho·∫°i (10 s·ªë)">
    <input id="diaChi" type="text" placeholder="ƒê·ªãa ch·ªâ giao h√†ng">
    <textarea id="ghiChu" placeholder="Ghi ch√∫ (gi·ªù giao, lo·∫°i c√∫ng...)"></textarea>
</div>

<div style="text-align:center; margin-top:20px;">
    <button class="zalo-btn" id="orderBtn" onclick="datHangZalo()">
        üì≤ ƒê·∫∑t h√†ng qua Zalo
    </button>
    <br><br>
    <button onclick="clearCart()">‚ùå X√≥a gi·ªè h√†ng</button>
    <br><br>
    <a href="index.html">‚¨Ö Quay l·∫°i mua h√†ng</a>
</div>

<script>
/* ====== FORMAT TI·ªÄN ====== */
function formatMoney(num) {
    return num.toLocaleString("vi-VN") + "ƒë";
}

/* ====== GI·ªé H√ÄNG ====== */
let cart = JSON.parse(localStorage.getItem("cart")) || [];
let isOrdering = false;

const cartDiv = document.getElementById("cart");
const totalDiv = document.getElementById("total");

/* ====== HI·ªÇN TH·ªä GI·ªé H√ÄNG ====== */
function renderCart() {
    if (cart.length === 0) {
        cartDiv.innerHTML = "<p>Gi·ªè h√†ng ƒëang tr·ªëng.</p>";
        totalDiv.innerText = "";
        return;
    }

    let total = 0;
    let html = "<ul>";

    cart.forEach((item, i) => {
        let itemTotal = item.gia * item.qty;
        total += itemTotal;

        html += `
        <li class="cart-item">
            <div>
                <b>${item.ten}</b><br>
                ${formatMoney(item.gia)} √ó ${item.qty} =
                <span class="item-total">${formatMoney(itemTotal)}</span>
            </div>
            <div class="qty-box">
                <button onclick="giam(${i})">‚ûñ</button>
                <span class="qty">${item.qty}</span>
                <button onclick="tang(${i})">‚ûï</button>
                <button class="remove-btn" onclick="removeItem(${i})">‚ùå</button>
            </div>
        </li>
        `;
    });

    html += "</ul>";
    cartDiv.innerHTML = html;
    totalDiv.innerText = "T·ªïng ti·ªÅn: " + formatMoney(total);
}

/* ====== TƒÇNG / GI·∫¢M ====== */
function tang(i) {
    cart[i].qty++;
    saveCart();
}
function giam(i) {
    cart[i].qty--;
    if (cart[i].qty <= 0) cart.splice(i, 1);
    saveCart();
}
function removeItem(i) {
    cart.splice(i, 1);
    saveCart();
}
function saveCart() {
    localStorage.setItem("cart", JSON.stringify(cart));
    renderCart();
}
function clearCart() {
    localStorage.removeItem("cart");
    renderCart();
}

/* ====== L∆ØU / T·∫¢I TH√îNG TIN KH√ÅCH ====== */
function saveCustomer() {
    localStorage.setItem("customer", JSON.stringify({
        ten: tenKhach.value,
        sdt: sdtKhach.value,
        diachi: diaChi.value,
        ghichu: ghiChu.value
    }));
}
function loadCustomer() {
    let info = JSON.parse(localStorage.getItem("customer"));
    if (!info) return;

    tenKhach.value = info.ten || "";
    sdtKhach.value = info.sdt || "";
    diaChi.value = info.diachi || "";
    ghiChu.value = info.ghichu || "";
}

/* ====== TR·∫†NG TH√ÅI N√öT ====== */
function setOrderLoading(isLoading) {
    const btn = document.getElementById("orderBtn");
    if (!btn) return;

    if (isLoading) {
        btn.innerText = "‚è≥ ƒêang g·ª≠i ƒë∆°n...";
        btn.disabled = true;
        btn.style.opacity = "0.6";
    } else {
        btn.innerText = "üì≤ ƒê·∫∑t h√†ng qua Zalo";
        btn.disabled = false;
        btn.style.opacity = "1";
    }
}

/* ====== ƒê·∫∂T H√ÄNG (CHU·∫®N ‚Äì KH√îNG L·ªñI) ====== */
function datHangZalo() {
    if (isOrdering) return;

    if (cart.length === 0) {
        alert("Gi·ªè h√†ng ƒëang tr·ªëng!");
        return;
    }

    let ten = tenKhach.value.trim();
    let sdt = sdtKhach.value.trim();
    let diaChiVal = diaChi.value.trim();
    let ghiChuVal = ghiChu.value.trim();

    if (!ten || !sdt || !diaChiVal) {
        alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!");
        return;
    }

    if (!/^\d{10}$/.test(sdt)) {
        alert("‚ùå S·ªë ƒëi·ªán tho·∫°i ph·∫£i ƒë√∫ng 10 ch·ªØ s·ªë!");
        return;
    }

    if (!confirm("‚úÖ B·∫°n ch·∫Øc ch·∫Øn mu·ªën ƒë·∫∑t ƒë∆°n n√†y?")) return;

    isOrdering = true;
    setOrderLoading(true);
    saveCustomer();

    /* ====== L∆ØU L·ªäCH S·ª¨ ƒê∆†N ====== */
    let orders = JSON.parse(localStorage.getItem("orders")) || [];
    orders.push({
        id: Date.now(),
        ten, sdt,
        diaChi: diaChiVal,
        ghiChu: ghiChuVal,
        items: cart,
        time: new Date().toLocaleString("vi-VN")
    });
    localStorage.setItem("orders", JSON.stringify(orders));

    /* ====== TIN NH·∫ÆN ZALO ====== */
    let message = `üïØÔ∏è ƒê∆†N ƒê·ªí C√öNG\nüë§ ${ten}\nüìû ${sdt}\nüìç ${diaChiVal}\n`;
    if (ghiChuVal) message += `üìù ${ghiChuVal}\n`;
    message += "\nüì¶ S·∫¢N PH·∫®M:\n";

    let total = 0;
    cart.forEach((item, i) => {
        let itemTotal = item.gia * item.qty;
        message += `${i + 1}. ${item.ten} (${item.qty}) = ${formatMoney(itemTotal)}\n`;
        total += itemTotal;
    });
    message += `\nüí∞ T·ªîNG TI·ªÄN: ${formatMoney(total)}`;

    window.open("https://zalo.me/84933188074", "_blank");
    navigator.clipboard.writeText(message);

    localStorage.removeItem("cart");

    alert("üéâ ƒê·∫∑t h√†ng th√†nh c√¥ng!\nShop s·∫Ω li√™n h·ªá qua Zalo ‚ù§Ô∏è");

    setTimeout(() => {
        setOrderLoading(false);
        window.location.href = "index.html";
    }, 1500);
}

loadCustomer();
renderCart();
</script>

</body>
</html>
